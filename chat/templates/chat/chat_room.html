{% extends 'base.html' %}

{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6">
    <!-- Chat Header -->
    <div class="bg-white rounded-t-2xl shadow-md p-4 border-b-2 border-gray-100">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <a href="{% url 'chat:chat_list' %}" class="p-2 hover:bg-gray-100 rounded-full transition">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                
                {% if other_user.profile_image %}
                <img src="{{ other_user.profile_image.url }}" alt="{{ other_user.username }}" class="w-12 h-12 rounded-full object-cover ring-2 ring-gray-200">
                {% else %}
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-400 via-pink-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg ring-2 ring-gray-200">
                    {{ other_user.username.0|upper }}
                </div>
                {% endif %}
                
                <div>
                    <h2 class="font-bold text-lg text-gray-900">{{ other_user.username }}</h2>
                    {% if other_user.full_name %}
                    <p class="text-sm text-gray-600">{{ other_user.full_name }}</p>
                    {% else %}
                    <div class="flex items-center gap-1">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-xs text-gray-500">Active</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Messages Container -->
    <div id="messages-container" class="bg-gradient-to-b from-gray-50 to-gray-100 p-6 h-[550px] overflow-y-auto flex flex-col-reverse">
        <div id="messages" class="flex flex-col space-y-4">
            {% for message in messages %}
            <div class="flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %} animate-fade-in">
                <div class="max-w-xs lg:max-w-md">
                    {% if message.sender != request.user %}
                    <div class="flex items-end gap-2 mb-1">
                        <span class="text-xs font-semibold text-gray-600">{{ message.sender.username }}</span>
                    </div>
                    {% endif %}
                    <div class="{% if message.sender == request.user %}bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-2xl rounded-tr-sm{% else %}bg-white text-gray-900 rounded-2xl rounded-tl-sm border border-gray-200{% endif %} px-4 py-3 shadow-sm">
                        <p class="text-sm leading-relaxed">{{ message.content }}</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 px-2 {% if message.sender == request.user %}text-right{% endif %}">
                        {{ message.created_at|date:"H:i" }}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Message Input -->
    <div class="bg-white rounded-b-2xl shadow-md p-4 border-t border-gray-100">
        <form id="message-form" class="flex gap-3">
            {% csrf_token %}
            <input 
                type="text" 
                id="message-input" 
                placeholder="Type your message..." 
                class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-red-400 transition" 
                autocomplete="off"
            >
            <button type="submit" class="px-6 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl font-semibold hover:from-red-600 hover:to-pink-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                <div class="flex items-center gap-2">
                    <span>Send</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </div>
            </button>
        </form>
    </div>
</div>

<style>
@keyframes fade-in {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in {
    animation: fade-in 0.3s ease-out;
}
</style>

<script>
const roomId = {{ room.id }};
const currentUserId = {{ request.user.id }};
const otherUsername = "{{ other_user.username }}";

// WebSocket connection
let chatSocket = null;

function connectChatWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/${roomId}/`;
    
    chatSocket = new WebSocket(wsUrl);
    
    chatSocket.onopen = function(e) {
        console.log('Chat WebSocket connected');
    };
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'message') {
            addMessageToChat(data.message);
        }
    };
    
    chatSocket.onclose = function(e) {
        console.log('Chat WebSocket disconnected, reconnecting...');
        setTimeout(connectChatWebSocket, 1000);
    };
    
    chatSocket.onerror = function(e) {
        console.error('Chat WebSocket error:', e);
    };
}

function addMessageToChat(message) {
    const messagesDiv = document.getElementById('messages');
    const isOwnMessage = message.sender_id === currentUserId;
    
    const messageHTML = `
        <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} animate-fade-in">
            <div class="max-w-xs lg:max-w-md">
                ${!isOwnMessage ? `<div class="flex items-end gap-2 mb-1"><span class="text-xs font-semibold text-gray-600">${otherUsername}</span></div>` : ''}
                <div class="${isOwnMessage ? 'bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-2xl rounded-tr-sm' : 'bg-white text-gray-900 rounded-2xl rounded-tl-sm border border-gray-200'} px-4 py-3 shadow-sm">
                    <p class="text-sm leading-relaxed">${escapeHtml(message.content)}</p>
                </div>
                <p class="text-xs text-gray-500 mt-1 px-2 ${isOwnMessage ? 'text-right' : ''}">
                    ${message.created_at}
                </p>
            </div>
        </div>
    `;
    
    messagesDiv.insertAdjacentHTML('beforeend', messageHTML);
    
    // Scroll to bottom
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Send message
document.getElementById('message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        
        messageInput.value = '';
        messageInput.focus();
    }
});

// Focus on input when page loads
document.getElementById('message-input').focus();

// Connect WebSocket
connectChatWebSocket();

// Scroll to bottom on page load
const container = document.getElementById('messages-container');
container.scrollTop = container.scrollHeight;

// Update unread badge when entering chat (messages are now read)
setTimeout(() => {
    fetch('/chat/api/unread-count/')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('unread-messages-badge');
            if (badge) {
                if (data.unread_count > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        });
}, 500);
</script>
{% endblock %}
